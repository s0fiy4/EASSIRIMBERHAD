<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATTENDANCE RECORDING</title>
    <link rel="icon" type="image/png" href="images/LOGOSIRIM.jpg" > <!-- Path to favicon -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .sidebar {
            background-color: #003366;
            color: white;
            width: 200px;
            height: 100vh;
            padding: 20px;
        }

        .sidebar h2 {
            font-size: 14px;
            margin-bottom: 30px;
            text-align: left;
            margin-left: 44px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 15px;
        }

        .sidebar a:hover {
            text-decoration: underline;
        }

        .logo-container {
        display: flex;
        align-items: left;
        justify-content: left;
        flex-direction: column; /* Stack logo and text vertically */
        margin-bottom: 10px;
    }

        .logo {
            width: 40px; /* Adjust width to fit your design */
            height: auto;
            margin-bottom: 5px;
            margin-top:-75px;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
        }

        .header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .attendance-list {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .attendance-list th,
        .attendance-list td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .attendance-list th {
            background-color: #f4f4f4;
        }

        .attendance-list .tools {
            text-align: center;
        }

        .attendance-list button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }

        .attendance-list button:hover {
            background-color: #0056b3;
        }

        .attendance-list .delete-button {
            background-color: #dc3545;
        }

        .attendance-list .delete-button:hover {
            background-color: #a71d2a;
        }

        .search-bar {
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .search-bar input {
            padding: 8px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .choose-event {
            margin-bottom: 10px;
        }

        .choose-event button {
            padding: 10px 20px;
            background-color: #003366;
            color: white;
            border: none;
            cursor: pointer;
        }

        .choose-event button:hover {
            background-color: #003366;
        }

        .save-attendance {
            text-align: right;
        }

        .save-attendance button {
            padding: 10px 20px;
            background-color: #003366;
            color: white;
            border: none;
            cursor: pointer;
        }

        .save-attendance button:hover {
            background-color: #003366;
        }

         /* Modal styles */
         .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 50%;
            text-align: center;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .close-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            float: right;
            font-size: 18px;
            margin-top: -20px;
            margin-right: -10px;
        }

        .close-button:hover {
            background-color: #a71d2a;
        }

        .modal-body button {
            padding: 10px 20px;
            background-color: #003366;
            color: white;
            border: none;
            cursor: pointer;
        }

        .modal-body button:hover {
            background-color: #003366;
        }

        .status-present {
            color: green;
            font-weight: bold;
        }
        .status-absent {
            color: red;
            font-weight: bold;
        }

        .modal-form {
            max-width: 500px;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }


        .btn-update {
            padding: 10px 25px;
            background-color: #1d72b8;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-update:hover {
            background-color: #145a86;
        }

        .walkin-form-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px 15px;
            padding: 20px;
            font-size: 14px;
        }

        .walkin-form-grid input {
            padding: 6px 10px;
            font-size: 14px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-button-row {
            grid-column: span 2;
            text-align: center;
            margin-top: 10px;
        }

        #walkInModal .modal-content {
            max-width: 600px;
            margin: 5% auto;
            padding: 20px 30px;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

    </style>
</head>
<body>
<body class="font-[Poppins] min-h-screen flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#003366] text-white p-6 flex flex-col">
    <div class="flex items-center mb-6">
      <img src="images/LOGOSIRIM.jpg" alt="SIRIM Logo" class="w-10 h-10 mr-2" />
      <h2 class="text-sm font-semibold leading-tight">EVENT ATTENDANCE<br>SIRIM BERHAD</h2>
    </div>
    <nav class="flex flex-col gap-4 mt-6">
      <a href="#" class="hover:underline">MAIN</a>
      <a href="homepage.html" class="hover:underline">HOMEPAGE</a>
      <a href="logout.php" class="hover:underline">LOG OUT</a>
    </nav>
  </aside>

    <div class="main-content">
        <div class="header" id="pageHeader">ATTENDANCE RECORDING</div>


        <div class="choose-event">
            <button id="chooseEventButton">CHOOSE EVENT</button>
            <button id="scanQRButton">SCAN QR</button>
            <button id="walkInButton">WALK-IN</button>
        </div>


        <div class="search-bar">
            <label for="search">SEARCH:</label>
            <input type="text" id="search" name="search" placeholder="Search attendees...">
        </div>

        <label for="statusFilter">STATUS:</label>
            <select id="statusFilter">
            <option value="">ALL STATUS</option>
            <option value="Present">PRESENT</option>
            <option value="Absent">ABSENT</option>
        </select>

        <label for="filter-walkin">WALK-IN:</label>
            <select id="filter-walkin">
            <option value="">ALL ATTENDEES</option>
            <option value="1">WALKIN-ONLY</option>
            <option value="0">REGISTERED ONLY</option>
        </select>


        <table class="attendance-list">
            <thead>
                <tr>
                    <th>ATTENDEE ID</th>
                    <th>ATTENDEE NAME</th>
                    <th>DEPT</th>
                    <th>ATTENDEE PHONENUM</th>
                    <th>EMAIL</th>
                    <th>COMPANY NAME</th>
                    <th>ATTENDANCE STATUS</th>
                    <th>TOOLS</th>
                </tr>
            </thead>
            <tbody id="attendeeTableBody"></tbody>
        </table>


    <!-- Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="closeModalButton">&times;</button>
            <div class="modal-header">SELECT AN EVENT</div>
            <div class="modal-body">
            <p>PLEASE CHOOSE AND EVENT:</p>
            <div id="eventList"></div> <!-- dynamic container -->
        </div>
        </div>
    </div>


 <!-- Walk-in Attendee Modal -->
<div class="modal" id="walkInModal">
  <div class="modal-content">
    <span class="close-walkin-modal" style="float:right;cursor:pointer;">&times;</span>
    <h2 style="text-align: center;">WALK-IN ATTENDEE</h2>

    <form id="walkInForm" class="walkin-form-grid" method="POST">
      <input type="hidden" name="event_id" id="walkInEventId">
      <input type="hidden" name="is_walkin" value="1">

      <label>NAME:</label>
      <input type="text" name="attendee_name" required>

      <label>DEPARTMENT:</label>
      <input type="text" name="dept_id">

      <label>PHONE NUMBER:</label>
      <input type="text" name="attendee_phonenum">

      <label>EMAIL:</label>
      <input type="email" name="email_attendee" required>

      <label>COMPANY NAME:</label>
      <input type="text" name="company_name">

      <label>POSITION:</label>
      <input type="text" name="position_attendee" required>

      <div class="form-button-row">
        <button type="submit" id="addWalkInBtn">ADD AND MARK PRESENT</button>
      </div>
    </form>
  </div>
</div>


<!-- Enhanced Edit Attendee Modal -->
<div id="editAttendeeModal" class="modal">
  <div class="modal-content modal-form">
    <span class="close-edit-modal" style="float: right; cursor: pointer;">&times;</span>
    <h2 style="text-align: center; margin-bottom: 20px;">EDIT ATTENDEE DETAILS</h2>
    <form id="editAttendeeForm" class="form-grid">
      <input type="hidden" name="attendee_id" id="editAttendeeId">

      <div class="form-group">
        <label for="editName">NAME:</label>
        <input type="text" name="attendee_name" id="editName" placeholder="Full Name" required>
      </div>

      <div class="form-group">
        <label for="editDept">DEPARTMENT:</label>
        <input type="text" name="dept_id" id="editDept" placeholder="Department" required>
      </div>

      <div class="form-group">
        <label for="editEmail">EMAIL:</label>
        <input type="email" name="email_attendee" id="editEmail" placeholder="Email Address" required>
      </div>

      <div class="form-group">
        <label for="editPhone">PHONE NUMBER:</label>
        <input type="text" name="attendee_phonenum" id="editPhone" placeholder="Phone Number">
      </div>

      <div class="form-group">
        <label for="editCompany">COMPANY NAME:</label>
        <input type="text" name="company_name" id="editCompany" placeholder="Company Name">
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <button type="submit" class="btn-update">UPDATE ATTENDEE</button>
      </div>
    </form>
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<div id="qrContainer" style="display:none; text-align:center;">
  <h3>Walk-In QR Code</h3>
  <div id="walkInQR"></div>
</div>

<script>
let currentEventId = null;
let allAttendees = [];

// URL params for QR scan attendance marking
const params = new URLSearchParams(window.location.search);
const emailParam = params.get('email');
const eventIdParam = params.get('event_id');

window.addEventListener('DOMContentLoaded', () => {
    loadEventList();

    // Modal open/close handlers
    document.getElementById('chooseEventButton')?.addEventListener('click', () => {
        document.getElementById('eventModal').style.display = 'block';
    });
    document.getElementById('closeModalButton')?.addEventListener('click', () => {
        document.getElementById('eventModal').style.display = 'none';
    });

    // QR scan button
    document.getElementById('scanQRButton')?.addEventListener('click', () => {
        if (!currentEventId) return alert("Please choose an event first.");
        window.open(`qr_scanner.html?event_id=${currentEventId}`, '_blank');
    });

    // Search and filter inputs
    document.getElementById('search')?.addEventListener('input', filterAttendees);
    document.getElementById('statusFilter')?.addEventListener('change', filterAttendees);
    document.getElementById('filter-walkin')?.addEventListener('change', filterAttendees);

    // Load event from QR link params, if any
    if (eventIdParam && !isNaN(eventIdParam) && emailParam) {
    currentEventId = parseInt(eventIdParam, 10); // ‚úÖ Convert to number
    document.getElementById('pageHeader').textContent = `Attendance - Event ID ${currentEventId}`;
    markAttendance(currentEventId, emailParam);
    }



    // Walk-in modal handlers
    const walkInModal = document.getElementById('walkInModal');
    document.getElementById('walkInButton')?.addEventListener('click', () => {
        if (!currentEventId) return alert("Please choose an event first.");
        document.getElementById('walkInEventId').value = currentEventId;
        walkInModal.style.display = 'block';
    });
    document.querySelector('.close-walkin-modal')?.addEventListener('click', () => {
        walkInModal.style.display = 'none';
    });
    window.addEventListener('click', (e) => {
        if (e.target === walkInModal) walkInModal.style.display = 'none';
    });

    // Walk-in form submission
    document.getElementById('walkInForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('add_walkin_attendee.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                alert("Walk-in attendee added successfully!");
                this.reset();
                walkInModal.style.display = 'none';
                loadAttendees(currentEventId);
                generateWalkInQR(response.attendee_email, currentEventId);
            } else {
                alert("Failed to add attendee: " + response.message);
            }
        })
        .catch(err => {
            console.error("Walk-in error:", err);
            alert("An error occurred while adding the attendee.");
        });
    });

    // Attendee table edit/delete (delegated listener)
    document.getElementById('attendeeTableBody')?.addEventListener('click', function (e) {
        const target = e.target;
        if (!target.dataset.id) return;
        const id = target.dataset.id;

        if (target.classList.contains('edit-button')) {
            const row = target.closest('tr');
            if (!row) return;

            // Use dataset attributes to populate edit modal
            const editModal = document.getElementById('editAttendeeModal');
            editModal.style.display = 'block';

            document.getElementById('editAttendeeId').value = id;
            document.getElementById('editName').value = row.dataset.name || '';
            document.getElementById('editDept').value = row.dataset.dept || '';
            document.getElementById('editEmail').value = row.dataset.email || '';
            document.getElementById('editPhone').value = row.dataset.phone || '';
            document.getElementById('editCompany').value = row.dataset.company || '';
        }

        if (target.classList.contains('delete-button')) {
            if (confirm("Are you sure you want to delete this attendee?")) {
                deleteAttendee(id);
            }
        }
    });

    // Edit modal close handlers
    const editModal = document.getElementById("editAttendeeModal");
    document.querySelector('.close-edit-modal')?.addEventListener('click', () => {
        editModal.style.display = 'none';
    });
    window.addEventListener("click", (e) => {
        if (e.target === editModal) editModal.style.display = "none";
    });

    // Edit form submission
    document.getElementById('editAttendeeForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('edit_attendee.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                alert("Attendee updated successfully.");
                editModal.style.display = 'none';
                loadAttendees(currentEventId);
            } else {
                alert("Update failed: " + response.message);
            }
        })
        .catch(err => {
            console.error("Error updating attendee:", err);
            alert("An error occurred.");
        });
    });

    // Save attendance button functionality placeholder
    document.querySelector('.save-attendance button')?.addEventListener('click', () => {
        if (!currentEventId) return alert("Please choose an event first.");

        // Here you can implement saving logic if needed
        alert("Attendance saved successfully! (Functionality to be implemented)");
    });

    // Auto-refresh attendees every 5 seconds
    setInterval(() => {
        if (currentEventId) loadAttendees(currentEventId);
    }, 5000);
});

// Fetch and display events
function loadEventList() {
    fetch('get_events_list.php')
        .then(res => res.json())
        .then(events => {
            const eventList = document.getElementById('eventList');
            if (!eventList) return;
            eventList.innerHTML = '';

            if (!Array.isArray(events) || events.length === 0) {
                eventList.innerHTML = '<p>No events found.</p>';
                return;
            }

            events.forEach(ev => {
                const btn = document.createElement('button');
                btn.textContent = ev.event_name;
                btn.classList.add('event-option');
                btn.addEventListener('click', () => {
                    currentEventId = ev.event_id;
                    document.getElementById('pageHeader').textContent = `Attendance - ${ev.event_name}`;
                    document.getElementById('eventModal').style.display = 'none';
                    loadAttendees(currentEventId);
                });
                eventList.appendChild(btn);
            });
        })
        .catch(err => {
            console.error('Failed to fetch events:', err);
            const eventList = document.getElementById('eventList');
            if (eventList) eventList.innerHTML = '<p>Error loading events.</p>';
        });
}

// Mark attendance for an email at an event
function markAttendance(eventId, email) {
    fetch('mark_attendance.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `event_id=${encodeURIComponent(eventId)}&email_attendee=${encodeURIComponent(email)}&status=Present`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) loadAttendees(eventId);
        else alert('Failed to mark attendance.');
    })
    .catch(err => {
        console.error('Error marking attendance:', err);
        alert('Error marking attendance.');
    });
}

// Load attendees and render table with filters and search
function loadAttendees(eventId) {
    fetch(`get_events_attendance.php?event_id=${eventId}`)
        .then(response => response.json())
        .then(data => {
            allAttendees = data; // Save original data for filtering
             filterAttendees(); 
        })
        .catch(error => {
            console.error("Failed to fetch attendees:", error);
        });
}

// Filter and display attendees based on search and filters
function filterAttendees() {
    if (!allAttendees || allAttendees.length === 0) {
        document.getElementById('attendeeTableBody').innerHTML = '<tr><td colspan="8">No attendees found.</td></tr>';
        return;
    }

    const searchTerm = document.getElementById('search').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const walkinValue = document.getElementById('filter-walkin').value;

    let filtered = allAttendees.filter(att => {
        const searchable = (att.attendee_name + att.email + att.dept_id + att.company_name).toLowerCase();
        if (!searchable.includes(searchTerm)) return false;

        if (statusFilter && att.attendance_status !== statusFilter) return false;

        if (walkinValue === '1' && parseInt(att.is_walkin) !== 1) return false;
        if (walkinValue === '0' && parseInt(att.is_walkin) !== 0) return false;

        return true;
    });

    const tbody = document.getElementById('attendeeTableBody');
    tbody.innerHTML = '';

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No attendees match the filters.</td></tr>';
        return;
    }

    filtered.forEach(att => {
        const tr = document.createElement('tr');

        tr.dataset.id = att.attendee_id;
        tr.dataset.name = att.attendee_name;
        tr.dataset.dept = att.dept_id;
        tr.dataset.email = att.email;
        tr.dataset.phone = att.attendee_phonenum;
        tr.dataset.company = att.company_name;

        tr.innerHTML = `
            <td>${att.attendee_id}</td>
            <td>${att.attendee_name} ${att.is_walkin == 1 ? '(Walk-in)' : ''}</td>
            <td>${att.dept_id}</td>
            <td>${att.attendee_phonenum}</td>
            <td>${att.email}</td>
            <td>${att.company_name}</td>
            <td style="color: ${att.attendance_status === 'Present' ? 'green' : 'red'}">
                ${att.attendance_status}
            </td>
            <td>
            <button class="edit-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded mr-2" data-id="${att.attendee_id}">Edit</button>
            <button class="delete-button bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-id="${att.attendee_id}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}



// Delete attendee by ID
function deleteAttendee(attendeeId) {
    fetch('delete_attendee.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `attendee_id=${encodeURIComponent(attendeeId)}`
    })
    .then(res => res.json())
    .then(response => {
        if (response.success) {
            alert('Attendee deleted.');
            loadAttendees(currentEventId);
        } else {
            alert('Failed to delete attendee: ' + response.message);
        }
    })
    .catch(err => {
        console.error('Delete error:', err);
        alert('Error deleting attendee.');
    });
}

function renderAttendees(data) {
    const tbody = document.getElementById("attendeeTableBody");
    tbody.innerHTML = '';

    data.forEach(att => {
        const tr = document.createElement("tr");
        tr.dataset.name = att.attendee_name;
        tr.dataset.dept = att.dept_id;
        tr.dataset.email = att.email;
        tr.dataset.phone = att.attendee_phonenum;
        tr.dataset.company = att.company_name;

        tr.innerHTML = `
            <td>${att.attendee_id}</td>
            <td>${att.attendee_name} ${att.is_walkin == 1 ? '(Walk-in)' : ''}</td>
            <td>${att.dept_id}</td>
            <td>${att.attendee_phonenum}</td>
            <td>${att.email}</td>
            <td>${att.company_name}</td>
            <td style="color: ${att.attendance_status === 'Present' ? 'green' : 'red'}">
                ${att.attendance_status}
            </td>
            <td>
<button class="edit-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded mr-2" data-id="${att.attendee_id}">‚úèÔ∏è Edit</button>
<button class="delete-button bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-id="${att.attendee_id}">üóëÔ∏è Delete</button>

            </td>
        `;
        tbody.appendChild(tr);
    });
}

</script>
</body>
</html>
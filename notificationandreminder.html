<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOTIFICATIONS & REMINDERS</title>
    <link rel="icon" type="image/png" href="images/LOGOSIRIM.jpg" > <!-- Icon -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .sidebar {
            background-color: #003366;
            color: white;
            width: 200px;
            height: 100vh;
            padding: 20px;
        }

        .sidebar h2 {
            font-size: 14px;
            margin-bottom: 30px;
            text-align: left;
            margin-left: 44px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 15px;
        }

        .sidebar a:hover {
            text-decoration: underline;
        }

        .logo-container {
        display: flex;
        align-items: left;
        justify-content: left;
        flex-direction: column; /* Stack logo and text vertically */
        margin-bottom: 10px;
    }

        .logo {
            width: 40px; /* Adjust width to fit your design */
            height: auto;
            margin-bottom: 5px;
            margin-top:-75px;
        }


        .main-content {
            flex-grow: 1;
            padding: 20px;
        }

        .header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .button {
            background-color: #003366;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            text-align: center;
            margin-bottom: 15px;
            display: inline-block;
        }
        .button:hover {
            background-color: #003366;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        table th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        .tools button {
            margin-right: 5px;
            padding: 5px 10px;
            background-color:#003366;
            color: white;
            border: none;
            cursor: pointer;
        }
        .tools button:hover {
            background-color: #003366;
        }
        .search-box {
            margin-bottom: 15px;
            margin-top: 20px;
        }
        .search-box input {
            padding: 5px;
            width: 200px;
        }

                /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            text-align: center;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
        }
        .modal-content input,
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            font-weight: bold;
            color: black;
            cursor: pointer;
        }
        .close-btn:hover {
            color: red;
        }

        .success-message {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #003366;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
        }

        .confirm {
            text-align: right;
        }

        .confirm button {
            padding: 10px 20px;
            background-color: #003366;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;

        }

        .confirm button:hover {
            background-color: #003366;
        }

        .floating-toolbar {
            position: fixed;
            top: 150px;
            left: 20px;
            z-index: 1000;
        }

        .floating-toolbar img {
            width: 32px;
            height: 32px;
            margin: 10px;
            cursor: pointer;
            background-color: #fff;
            padding: 6px;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }


</style>
</head>
<body class="min-h-screen flex bg-gray-100 overflow-y-auto">

  <!-- Sidebar -->
  <aside class="w-64 bg-[#003366] text-white p-6 flex flex-col shrink-0">
    <div class="flex items-center mb-6">
      <img src="images/LOGOSIRIM.jpg" alt="SIRIM Logo" class="w-10 h-10 mr-2" />
      <h2 class="text-sm font-semibold leading-tight">EVENT ATTENDANCE<br>SIRIM BERHAD</h2>
    </div>
    <nav class="flex flex-col gap-4 mt-6">
      <a href="#" class="hover:underline">MAIN</a>
      <a href="homepage.html" class="hover:underline">HOMEPAGE</a>
      <a href="logout.php" class="hover:underline">LOG OUT</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 overflow-x-hidden">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold text-gray-800">NOTIFICATIONS & REMINDERS</h1>
      <button id="openModalBtn" class="bg-[#003366] text-white px-4 py-2 rounded shadow hover:bg-[#002244]">+ ADD NOTIFICATION</button>
    </div>

    <div class="mb-4">
      <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
      <input type="text" id="search" placeholder="Search..." class="mt-1 block w-64 border-gray-300 rounded-md shadow-sm" />
    </div>

 <div class="overflow-x-auto rounded-lg shadow max-w-full">
      <table class="w-full table-auto">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">NOTIFICATION ID</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">EVENT ID</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">TYPE</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">DETAILS</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">SEND TO</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">EMAILS</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">CREATED AT</th>
            <th class="px-4 py-2 text-left text-sm font-bold text-gray-600 whitespace-nowrap">TOOLS</th>
          </tr>
        </thead>
        <tbody id="notificationTable" class="bg-white divide-y divide-gray-200">
          <!-- Dynamic rows go here -->
        </tbody>
      </table>
    </div>
  </main>

  <div class="overflow-x-auto rounded-lg shadow max-w-full">
  <table class="w-full table-auto">
    <!-- Your table rows -->
  </table>
</div>

<!-- Add Notification Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
      <span class="close-btn" id="closeModalBtn">&times;</span>
      <h2>Add New Notification / Reminder</h2>
      <form id="notificationForm" action="add_notification.php" method="POST" enctype="multipart/form-data">
          <input type="text" name="notif_id" placeholder="Notification ID" required />
          <input type="text" name="event_id" id="eventIdInput" placeholder="Event ID" required />

          <select name="notification_type" required>
              <option value="New Events">New Events</option>
              <option value="Reminder">Reminder</option>
              <option value="Qr pass">QR Pass</option>
              <option value="Payment">Payment</option>
              <option value="Certificate">Certificate</option>
          </select>

          <div id="qrButtonWrapper" style="margin-top: 10px; display: none;">
              <button type="button" onclick="sendQRPass()">Send QR Pass</button>
          </div>

          <textarea id="details" name="details" placeholder="Details..." rows="3" style="width: 100%;"></textarea>

          <div style="margin-top: 10px;">
              <button type="button" id="showImageUpload" class="button" style="background-color: #ccc; color: #000; padding: 5px 10px;">
                  ðŸ“· Add Image
              </button>
          </div>

          <div id="imageUploadSection" style="display: none; margin-top: 10px;">
              <input type="file" id="imageUploadInput" name="attachment" accept="image/*" />
              <img id="previewImage" style="display: none; width: 100px; margin-top: 10px;" />
          </div>

          <label>Send To:
              <select name="send_to" id="sendToDropdownMain" required>
                  <option value="ALL">ALL</option>
                  <option value="Specific">Specific</option>
              </select>
          </label>

          <div id="emailInputContainer" style="display: none; margin-top: 10px;">
              <input type="email" name="specific_email" id="specificEmailInput" placeholder="Enter specific email" />
          </div>

          <button type="submit" class="button">Submit</button>
      </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
      <span class="close-btn" id="deleteCloseBtn">&times;</span>
      <h2>CONFIRM DELETE</h2>
      <p>ARE YOU SURE YOU WANT TO DELETE THIS NOTIFICATION?</p>
      <button class="confirm-btn" id="confirmDeleteBtn">Yes, Delete</button>
      <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close-btn" id="editCloseBtn">&times;</span>
    <h2>Edit Notification</h2>
    <form id="editForm">
      <input type="hidden" id="edit_notification_id" name="notif_id" />
      <input type="number" id="edit_event_id" name="event_id" class="form-control" placeholder="Event ID" required /><br />
      <input type="text" id="edit_type" name="notification_type" class="form-control" placeholder="Notification Type" required /><br />
      <textarea id="edit_details" name="details" class="form-control" placeholder="Details" required></textarea><br />
      
      <label for="sendToDropdownEdit">Send To:</label>
      <select id="sendToDropdownEdit" name="send_to" class="form-control" required>
        <option value="ALL">ALL</option>
        <option value="Specific">Specific</option>
      </select>

      <div id="editEmailInputContainer" style="display: none; margin-top: 10px;">
        <input type="email" id="edit_specific_email" name="specific_email" placeholder="Enter specific email" />
      </div>

      <button type="submit" class="button">Save</button>
      <button type="button" class="button" id="editCancelBtn">Cancel</button>
    </form>
  </div>
</div>

<!-- Confirm Changes Modal -->
<div class="modal" id="confirmChangesModal">
  <div class="modal-content">
      <span class="close-btn" id="confirmCloseBtn">&times;</span>
      <h2>CONFIRM CHANGES</h2>
      <p>ARE YOU SURE YOU WANT TO SAVE THESE CHANGES?</p>
      <button class="confirm-btn" id="confirmSaveBtn">YES</button>
      <button class="cancel-btn" id="cancelSaveBtn">CANCEL</button>
  </div>
</div>


<script>
  // Modal Elements
  const modal = document.getElementById('modal');
  const openModalBtn = document.getElementById('openModalBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const deleteModal = document.getElementById('deleteModal');
  const deleteCloseBtn = document.getElementById('deleteCloseBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const editModal = document.getElementById('editModal');
  const editCloseBtn = document.getElementById('editCloseBtn');
  const editCancelBtn = document.getElementById('editCancelBtn');
  const editForm = document.getElementById('editForm');
  const confirmChangesModal = document.getElementById('confirmChangesModal');
  const confirmCloseBtn = document.getElementById('confirmCloseBtn');
  const cancelSaveBtn = document.getElementById('cancelSaveBtn');
  const confirmSaveBtn = document.getElementById('confirmSaveBtn');

  // Open Add Modal
  openModalBtn?.addEventListener('click', () => modal.style.display = 'flex');
  closeModalBtn?.addEventListener('click', () => modal.style.display = 'none');

  // Edit Modal close buttons
  editCloseBtn?.addEventListener('click', () => editModal.style.display = 'none');
  editCancelBtn?.addEventListener('click', () => editModal.style.display = 'none');

  // Delete Modal close buttons
  deleteCloseBtn?.addEventListener('click', () => deleteModal.style.display = 'none');
  cancelDeleteBtn?.addEventListener('click', () => deleteModal.style.display = 'none');

  // Confirm Changes Modal close buttons
  confirmCloseBtn?.addEventListener('click', () => confirmChangesModal.style.display = 'none');
  cancelSaveBtn?.addEventListener('click', () => confirmChangesModal.style.display = 'none');

  // Image Upload toggle
  const showImageUpload = document.getElementById('showImageUpload');
  const imageUploadSection = document.getElementById('imageUploadSection');
  const imageUploadInput = document.getElementById('imageUploadInput');
  const previewImage = document.getElementById('previewImage');

  showImageUpload?.addEventListener('click', () => {
    if (imageUploadSection.style.display === 'none' || !imageUploadSection.style.display) {
      imageUploadSection.style.display = 'block';
    } else {
      imageUploadSection.style.display = 'none';
      previewImage.style.display = 'none';
      imageUploadInput.value = '';
    }
  });

  imageUploadInput?.addEventListener('change', function () {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
      };
      reader.readAsDataURL(this.files[0]);
    }
  });

  // Show/hide specific email input
  const sendToDropdownMain = document.getElementById('sendToDropdownMain');
  const emailInputContainer = document.getElementById('emailInputContainer');

  sendToDropdownMain?.addEventListener('change', () => {
    emailInputContainer.style.display = sendToDropdownMain.value === 'Specific' ? 'block' : 'none';
  });

  // Edit modal: show/hide specific email input
  const sendToDropdownEdit = document.getElementById('sendToDropdownEdit');
  const editEmailInputContainer = document.getElementById('editEmailInputContainer');

  sendToDropdownEdit?.addEventListener('change', () => {
    if (!editEmailInputContainer) return;
    editEmailInputContainer.style.display = sendToDropdownEdit.value === 'Specific' ? 'block' : 'none';
  });

  // QR button display based on type
  const notificationTypeSelect = document.querySelector('select[name="notification_type"]');
  const qrButtonWrapper = document.getElementById('qrButtonWrapper');

  notificationTypeSelect?.addEventListener('change', () => {
    if (!qrButtonWrapper) return;
    qrButtonWrapper.style.display = notificationTypeSelect.value === 'Qr pass' ? 'block' : 'none';
  });


  // Load notifications from backend
  async function loadNotifications() {
    try {
      const response = await fetch('displaynotification.php');
      if (!response.ok) throw new Error('Network error');

      const result = await response.json();
      if (!result.success) throw new Error('Server error');

      const tbody = document.querySelector('#notificationTable');
      tbody.innerHTML = '';

      result.data.forEach(notif => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${notif.notif_id}</td>
          <td>${notif.event_id}</td>
          <td>${notif.notification_type}</td>
          <td>${notif.details}</td>
          <td>${notif.send_to}</td>
          <td>${notif.specific_email || ''}</td>
          <td>${notif.created_at}</td>
          <td>
            <button class="edit-btn" data-id="${notif.notif_id}">Edit</button>
            <button class="delete-btn" data-id="${notif.notif_id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      attachEditDeleteListeners();
    } catch (err) {
      console.error('Error loading notifications:', err);
    }
  }

  // Attach edit/delete button listeners
  function attachEditDeleteListeners() {
    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', () => {
        const notifId = button.dataset.id;
        openEditModal(notifId);
      });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', () => {
        const notifId = button.dataset.id;
        openDeleteModal(notifId);
      });
    });
  }

  // Open Edit Modal with fetched data
  async function openEditModal(notifId) {
    try {
      console.log("Fetching notification:", notifId);

      const response = await fetch(`get_notifications.php?notif_id=${notifId}`);
      const result = await response.json();

      if (result.success) {
        const notif = result.data;

        document.getElementById('edit_notification_id').value = notif.notif_id;
        document.getElementById('edit_event_id').value = notif.event_id;
        document.getElementById('edit_type').value = notif.notification_type;
        document.getElementById('edit_details').value = notif.details;

        const sendToDropdown = document.getElementById('sendToDropdownEdit');
        sendToDropdown.value = notif.send_to;

        if (notif.send_to === 'Specific') {
          if (editEmailInputContainer) editEmailInputContainer.style.display = 'block';
          document.getElementById('edit_specific_email').value = notif.specific_email || '';
        } else {
          if (editEmailInputContainer) editEmailInputContainer.style.display = 'none';
        }

        editModal.style.display = 'flex';
      } else {
        alert('Failed to load notification data: ' + result.message);
      }
    } catch (err) {
      console.error('Error fetching notification:', err);
      alert('Error fetching notification.');
    }
  }

  // Submit edited notification
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);

    try {
      const response = await fetch('edit_notification.php', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        alert('Notification updated.');
        editModal.style.display = 'none';
        loadNotifications();
      } else {
        alert('Failed to update notification.');
      }
    } catch (err) {
      alert('Error updating notification.');
      console.error(err);
    }
  });

  // Delete modal logic
  let notificationIdToDelete = null;

  function openDeleteModal(notifId) {
    notificationIdToDelete = notifId;
    deleteModal.style.display = 'flex';
  }

  confirmDeleteBtn?.addEventListener('click', async () => {
    if (!notificationIdToDelete) return;

    try {
      const formData = new FormData();
      formData.append('notif_id', notificationIdToDelete);

      const response = await fetch('delete_notification.php', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        alert('Notification deleted.');
        deleteModal.style.display = 'none';
        loadNotifications();
      } else {
        alert('Delete failed.');
      }
    } catch (err) {
      alert('Error deleting notification.');
      console.error(err);
    }
  });

  // Live search
  document.getElementById('search')?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#notificationTable tr').forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
    });
  });

  // Initial data load
  window.addEventListener('load', loadNotifications);
</script>



</body>
</html>


